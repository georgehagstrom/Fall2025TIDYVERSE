---
title: "R and SQL"
author: "Samantha Mesa"
date: "`r Sys.Date()`"
output: openintro::lab_report
---

```{r load-packages, message=FALSE}
library(tidyverse)
library(openintro)
library(nycflights13)
library(ggplot2)
library(DBI)
library(duckdb)
library(dbplyr)
library(stringr)
```

### Exercise 1

for aircraft that have recorded more than 30 flights, utilizing the flights_by_tail dataset. Subsequently, I pinpointed the carriers that exhibited the highest number of missing matches between the tailnum values in the flights data and those in the planes dataset, as outlined in the missing_by_carrier output. Following this, I identified the aircraft model with the highest total number of flights (model_name) and created a plot that illustrates the mean departure delay according to the year of manufacture. This plot served to briefly analyze the correlation between the age of the aircraft and the average delay, investigating whether older planes are prone to longer or shorter delays compared to their newer counterparts.

```{r}
flights_by_tail <- flights %>%
filter(!is.na(tailnum)) %>%
group_by(tailnum) %>%
summarise(
n_flights = n(),
mean_dep_delay = mean(dep_delay, na.rm = TRUE),
.groups = "drop"
) %>%
filter(n_flights > 30) %>%
arrange(desc(mean_dep_delay))

print(head(flights_by_tail, 10))

```
```{r}
missing_plane_matches <- flights %>%
filter(!is.na(tailnum)) %>%
anti_join(planes, by = "tailnum")

missing_by_carrier <- missing_plane_matches %>%
count(carrier, sort = TRUE) %>%
left_join(airlines, by = "carrier")

missing_by_carrier
```
```{r}
flights_models <- flights %>% 
filter(!is.na(tailnum)) %>%
left_join(planes, by = "tailnum")

top_model <- flights_models %>%
count(model, sort = TRUE) %>%
filter(!is.na(model)) %>%
slice_max(n, n = 1)

top_model

model_name <- top_model$model[1]

model_flights <- flights %>%
  filter(!is.na(tailnum)) %>%
left_join(planes %>% select(tailnum, plane_year = year, model), by = "tailnum") %>%
filter(model == model_name)

avg_delay_by_plane_year <- model_flights %>%
group_by(plane_year) %>%
summarise(
n_flights = n(),
mean_dep_delay = mean(dep_delay, na.rm = TRUE),
.groups = "drop"
) %>%
filter(!is.na(plane_year))

avg_delay_by_plane_year

ggplot(avg_delay_by_plane_year, aes(plane_year, mean_dep_delay, size = n_flights)) +
geom_point(alpha = 0.6) +
geom_smooth(method = "loess", se = TRUE) +
labs(
title = paste("Average Departure Delay by Manufacture Year â€“", model_name),
x = "Plane Manufacture Year", y = "Mean Departure Delay (min)",
size = "Flights"
) +
theme_minimal()

```

### Exercise 2
The hue of each point reflects the average arrival delay, while the size of the point signifies the volume of flights to that particular destination. This offers a spatial representation of flight performance across various locations.
```{r}
avg_delay_dest <- flights %>%
filter(!is.na(dest)) %>%
group_by(dest) %>%
summarize(
n_flights = n(),
mean_arr_delay = mean(arr_delay, na.rm = TRUE),
.groups = "drop"
) %>%
inner_join(airports, by = c("dest" = "faa"))

ggplot() +
borders("state") +
geom_point(
data = avg_delay_dest,
aes(lon, lat, size = n_flights, color = mean_arr_delay),
alpha = 0.8
) +
coord_quickmap() +
scale_color_viridis_c(option = "plasma", name = "Mean Arr Delay (min)") +
labs(
title = "Average Arrival Delay by Destination Airport",
x = "Longitude", y = "Latitude", size = "Flights"
) +
theme_minimal()
```

### Exercise 3
I also presented the results of the sector_name variable split, which produced two new variables: sector_type and program_years, along with the re-leveled factor variable classification_name for clearer categorical interpretation.

```{r}
SPC=read_csv(r"(C:\Users\sammy\OneDrive\Documents\Data607\sports_program_costs.csv)")

glimpse(SPC)

unique(SPC$sector_name) %>% head(20) %>% print()

IDC <- names(SPC)[str_detect(names(SPC), regex("unitid|unit_id|inst_id|institution|ope|opeid", ignore_case = TRUE))]

IDC

ID <- if(length(IDC) > 0) IDC[1] else stop("No institution id column found; please tell me the column name for institution identifier (e.g., unitid).")

col_levels <- SPC %>%
group_by(across(all_of(ID))) %>%
summarize(across(everything(), ~ n_distinct(.x, na.rm = TRUE)), .groups = "drop")

const_cols <- col_levels %>%
select(-all_of(ID)) %>%
summarize(across(everything(), ~ all(. <= 1, na.rm = TRUE))) %>%
pivot_longer(everything(), names_to = "col", values_to = "is_constant") %>%
filter(is_constant) %>%
pull(col)

TC <- setdiff(names(SPC), const_cols)

colleges <- SPC %>%
select(all_of(c(ID, const_cols))) %>%
distinct()

teams <- SPC %>%
select(all_of(c(ID, TC)))

nrow(colleges); nrow(teams)
```
```{r}
SPC2 <- SPC %>%
separate_wider_delim(sector_name, delim = " - ",
names = c("sector_type", "program_years"), too_few = "align_start") %>%
mutate(
across(c(state_cd, zip_text, classification_name,
sports, sector_type, program_years), as.factor)
)

if("classification_code" %in% names(SPC2))
SPC2<- SPC2 %>%
mutate(classification_name =
fct_reorder(classification_name, as.numeric(classification_code)))

glimpse(SPC2)

```

### Exercise 4
Finally, I included the SQL query and output showing the top 10 colleges ranked by average football profit, including both the show_query() SQL statement and the resulting collect() output table.

```{r}
dpn <- "sports_normalized.duckdb"
cn <- dbConnect(duckdb(), dbdir = dpn)

dbWriteTable(cn, "colleges", colleges, overwrite = TRUE)
dbWriteTable(cn, "teams", teams, overwrite = TRUE)

dbDisconnect(cn, shutdown = TRUE)

csv_size  <- file.info("sports_program_costs.csv")$size
norm_size <- file.info(dpn)$size

data.frame(File = c("Original CSV", "Normalized DuckDB"),
Size_Bytes = c(csv_size, norm_size))

```

```{r}
dps <- "sports_single.duckdb"
con_single <- dbConnect(duckdb(), dbdir = dps)
dbWriteTable(con_single, "sports_all", SPC2, overwrite = TRUE)
dbDisconnect(con_single, shutdown = TRUE)

single_size <- file.info(dps)$size

data.frame(
File = c("Normalized DB", "Single-table DB"),
Size_Bytes = c(norm_size, single_size),
Ratio = norm_size / single_size
)
```

```{r}
cn <- dbConnect(duckdb(), dbdir = dpn)

teams_db    <- tbl(cn, "teams")
colleges_db <- tbl(cn, "colleges")

football_profit_query <- teams_db %>%
  filter(sports == "Football") %>%                      
  mutate(profit = total_rev_menwomen - total_exp_menwomen) %>% 
  group_by(unitid) %>%                                  
  summarise(avg_profit = mean(profit, na.rm = TRUE)) %>%
  arrange(desc(avg_profit)) %>%
  head(10)

football_profit_query %>% show_query()

top10_football_profit <- football_profit_query %>% collect()
top10_football_profit

dbDisconnect(cn, shutdown = TRUE)



```
...

