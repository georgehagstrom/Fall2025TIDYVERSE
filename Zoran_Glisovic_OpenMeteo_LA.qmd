---
title: "Los Angeles Monthly Average Temperature Trends (1975–2024)"
author: "Zoran Glisovic"
format:
  pdf:
    toc: true
execute:
  echo: true
  warning: false
  message: false
editor: source
---

# Overview

Goal: fetch hourly temperature_2m for Los Angeles (1975–2024) from the Open‑Meteo Historical Weather API with httr2, aggregate to monthly averages, and plot trends.  
Key implementation choices:
- Request UTC timestamps, parse in UTC, then convert to America/Los_Angeles to avoid DST parsing warnings.
- Fetch one year per request to keep responses small and reliable.

API docs: https://open-meteo.com/en/docs/historical-weather-api

# Setup

In this section, I load the required R packages. The httr2 package is used to interact with APIs, lubridate for date and time handling, and ggplot2 for visualizations.

```{r global-options}
library(httr2)
library(jsonlite)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(purrr)
```

# Acquire hourly data (UTC → local)

Here I build a function that sends yearly API requests to the Open-Meteo Historical Weather API for Los Angeles coordinates. To avoid data gaps due to daylight savings time, the data is requested in UTC and converted to local time afterward.

```{r hourly-data}
lat <- 34.0522
lon <- -118.2437
years <- 1975:2024

fetch_year_utc <- function(y) {
  req <- request("https://archive-api.open-meteo.com/v1/archive") |>
    req_url_query(
      latitude = lat, longitude = lon,
      start_date = paste0(y, "-01-01"),
      end_date = paste0(y, "-12-31"),
      hourly = "temperature_2m",
      timezone = "UTC"
    )
  resp <- req_perform(req); resp_check_status(resp)
  raw <- resp_body_json(resp, simplifyVector = TRUE)
  if (is.null(raw$hourly) || is.null(raw$hourly$time)) return(tibble())
  tibble(
    datetime_utc = ymd_hm(raw$hourly$time, tz = "UTC"),
    datetime_local = with_tz(datetime_utc, "America/Los_Angeles"),
    t2m_c = raw$hourly$temperature_2m
  )
}

hourly <- map_dfr(years, ~{
  tryCatch({
    out <- fetch_year_utc(.x)
    Sys.sleep(0.2)
    out
  }, error = function(e) tibble())
})

start_local <- as.POSIXct("1975-01-01 00:00:00", tz = "America/Los_Angeles")
end_local   <- as.POSIXct("2024-12-31 23:00:00", tz = "America/Los_Angeles")
hourly <- hourly |>
  filter(datetime_local >= start_local, datetime_local <= end_local)
nrow(hourly)
```

The resulting dataset contains about 438,000 hourly records spanning 1975–2024. This data provides a continuous temperature history for Los Angeles that can be further summarized for analysis.


# Aggregate to monthly averages

Next, I group the hourly observations by year and month to compute monthly average temperatures in both Celsius and Fahrenheit. This aggregation simplifies the long hourly dataset into a manageable format for visualization and trend analysis.

```{r monthly-mean}
monthly <- hourly |>
  mutate(
    year = year(datetime_local),
    month = month(datetime_local),
    mon_lab = factor(month(datetime_local, 
                           label = TRUE, abbr = TRUE), levels = month.abb)
  ) |>
  group_by(year, month, mon_lab) |>
  summarise(tavg_c = mean(t2m_c, na.rm = TRUE), .groups = "drop") |>
  mutate(tavg_f = tavg_c * 9/5 + 32)

nrow(monthly)

monthly
```
The table shows approximately 600 monthly averages, representing 50 years of data.

# Visualize

Using ggplot2, I create two sets of plots. The first set shows monthly temperature trends across years for each month, and the second plot summarizes the annual averages with a fitted linear regression line.

```{r faceted-plots, fig.width = 10, fig.height = 8, dpi = 300}
ggplot(monthly, aes(x = year, y = tavg_f)) +
  geom_line() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  facet_wrap(~ mon_lab, ncol = 4) +
  labs(
    title = "Los Angeles: Monthly Average Temperature (1975–2024)",
    x = "Year", y = "Avg temperature (°F)",
    caption = "Open-Meteo Historical Weather API"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r annual-mean, fig.width = 10, fig.height = 8, dpi = 300}
annual <- monthly |>
  group_by(year) |>
  summarise(tavg_f = mean(tavg_f, na.rm = TRUE), .groups = "drop")

ggplot(annual, aes(x = year, y = tavg_f)) +
  geom_line() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Los Angeles: Annual Average Temperature (1975–2024)",
       x = "Year", y = "Annual avg temperature (°F)",
       caption = "Open-Meteo Historical Weather API") +
  theme_minimal(base_size = 12)
```
These plots make it easier to see subtle long-term changes in temperature. The blue trend lines indicate that winters have warmed slightly while some summer months appear to show mild cooling over time.

```{r difference}
trend_values <- tibble(
  year = c(1975, 2024),
  trend_tavg_f = predict(lm(tavg_f ~ year, data = annual),
                         newdata = tibble(year = c(1975, 2024)))
)

print(trend_values)

temp_diff <- diff(trend_values$trend_tavg_f)
cat("Predicted temperature increase from 1975 to 2024 (trend line):",
    round(temp_diff, 2), "°F\n")
```

# Conclusion

Using the Open-Meteo Historical Weather API, I collected hourly temperature data for Los Angeles from 1975 through 2024 and aggregated it into monthly and annual averages. To avoid daylight savings time issues, the data was requested in UTC and then converted to local Los Angeles time.

The annual linear trend shows a gradual increase in average temperature over the 50-year period. Based on the model, Los Angeles has warmed by roughly half a degree Fahrenheit since 1975. While the overall rise is modest, the monthly trend plots reveal interesting seasonal differences—winter months are getting noticeably warmer, while summer months show a small cooling trend.

This pattern suggests that the city’s temperature range is narrowing slightly, with milder winters and somewhat cooler peak summer periods. These results align with broader regional climate trends across Southern California, where nighttime and winter temperatures have risen faster than summer highs. Because Open-Meteo data combine reanalysis and model information, values may differ slightly from local weather station records, but the long-term direction remains clear: Los Angeles has become warmer overall, especially in the cooler months, over the past five decades.
