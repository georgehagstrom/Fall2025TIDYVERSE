---
title: "Los Angeles Monthly Average Temperature Trends (1975-2024)"
authors: 
  - "Zoran Glisovic"
  - "Masoud Mahdisoltani" 
format:
  pdf:
    toc: false
execute:
  echo: true
  warning: false
  message: false
editor_options: 
  chunk_output_type: console
---

# Overview

Goal: fetch hourly temperature_2m for Los Angeles (1975-2024) from the Open-Meteo Historical Weather API with httr2, aggregate to monthly averages, and plot trends.  
Key implementation choices:
- Request UTC timestamps, parse in UTC, then convert to America/Los_Angeles to avoid DST parsing warnings.
- Fetch one year per request to keep responses small and reliable.

Extended goal: adding rainfall data to the analysis.

API docs: https://open-meteo.com/en/docs/historical-weather-api

# Setup

In this section, the required R packages are loaded. The `httr2` package is used to interact with APIs, `lubridate` for date and time handling, and `ggplot2` for visualizations.

```{r global-options}
library(httr2)
library(jsonlite)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(purrr)
```

# Acquire hourly data

Here, `fetch_year_utc` function sends yearly API requests to the Open-Meteo Historical Weather API for Los Angeles coordinates. To avoid data gaps due to daylight savings time, the data is requested in UTC and converted to local time afterward, to avoid dealing with daylight savings time issues.

```{r hourly-data}
lat <- 34.0522
lon <- -118.2437
years <- 1975:2024


fetch_year_utc <- function(y) {
  req <- request("https://archive-api.open-meteo.com/v1/archive") |>
    req_url_query(
      latitude = lat, longitude = lon,
      start_date = paste0(y-1, "-12-31"),
      end_date = paste0(y+1, "-01-01"),
      hourly = "temperature_2m,rain",
      timezone = "UTC"
    )
  resp <- req_perform(req); resp_check_status(resp)
  raw <- resp_body_json(resp, simplifyVector = TRUE)
  if (is.null(raw$hourly) || is.null(raw$hourly$time)) return(tibble())
  tibble(
    datetime_utc = ymd_hm(raw$hourly$time, tz = "UTC"),
    datetime_local = with_tz(datetime_utc, "America/Los_Angeles"),
    t2m_c = raw$hourly$temperature_2m,
    rain_in  = raw$hourly$rain / 25.4
  )
}

hourly <- map(years, ~{
  tryCatch({
    out <- fetch_year_utc(.x)
    Sys.sleep(0.2)
    out
  }, error = function(e) tibble())
}) %>% 
  list_rbind()

hourly <- hourly |>
  filter(between(year(datetime_local), min(years), max(years))) |>
  distinct()

nrow(hourly)
```

The resulting dataset contains about 438,000 hourly records spanning 1975-2024. This data provides a continuous temperature and rainfall history for Los Angeles that can be further summarized for analysis.

# Aggregate to monthly means

Next, hourly observations are grouped by year and month to compute monthly and annual means for temperatures and total rainfall. This aggregation simplifies the long hourly dataset into a manageable format for visualization and trend analysis.

```{r monthly-annual}
monthly <- hourly |>
  mutate(
    year = year(datetime_local),
    month = month(datetime_local)
  ) |>
  summarize(tavg_c = mean(t2m_c, na.rm = TRUE),
            rtot_in = sum(rain_in, na.rm = TRUE),
            .by = c(year, month)) |>
  mutate(tavg_f = tavg_c * 9/5 + 32, .keep = "unused")

annual <- monthly |>
  summarise(tavg_f = mean(tavg_f, na.rm = TRUE), 
            rtot_in = sum(rtot_in, na.rm = TRUE),
            .by = year)
```

`r nrow(monthly)` months over the span of `r nrow(annual)` years.

# Visualize

`ggplot2` package is used to create multiple sets of plots for rainfall and temperature, both for monthly and annual data.

### Temperature:

```{r faceted-plots-temp, fig.width = 10, fig.height = 8, dpi = 300}
ggplot(monthly, aes(x = year, y = tavg_f)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, color = "#a52b0d") +
  facet_wrap(~ month, ncol = 4, 
             labeller = labeller(month = \(x) month.abb[as.numeric(x)])) +
  labs(
    title = "Los Angeles: Monthly Mean Temperature (1975-2024)",
    x = "", y = "Mean Temperature (°F)",
    caption = "Open-Meteo Historical Weather API"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

These plots reveal interesting seasonal patterns in Los Angeles temperatures over time. The LOESS smoothing curves suggest some months (like April and December) may show warming trends while others (like June and September) appear relatively stable or slightly cooling. However, these are visual patterns and further analyses is needed to make more robust conclusions.

```{r annual-mean-temp, fig.width = 10, fig.height = 8, dpi = 300}
ggplot(annual, aes(x = year, y = tavg_f)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, color = "#a52b0d") +
  labs(title = "Los Angeles: Annual Mean Temperature (1975-2024)",
       x = "", y = "Mean Temperature (°F)",
       caption = "Open-Meteo Historical Weather API") +
  theme_bw(base_size = 12)
```

The annual mean temperature shows considerable year-to-year variability with no significant long-term trend. The LOESS curve suggests a possible slight increase through the 2010s followed by recent cooling, but it is suspected that statistical testing would confirm this is not a significant trend.

## Rainfall:

```{r faceted-plots-rain, fig.width = 10, fig.height = 8, dpi = 300}
ggplot(monthly, aes(x = year, y = rtot_in)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, color = "#3366cc") +
  facet_wrap(~ month, ncol = 4, 
             labeller = labeller(month = \(x) month.abb[as.numeric(x)])) +
  labs(
    title = "Los Angeles: Monthly Total Rainfall (1975-2024)",
    x = "Year", y = "Total Rainfall (in)",
    caption = "Open-Meteo Historical Weather API"
  ) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

These plots clearly show that outside of December to March, Los Angeles experiences very dry seasons consistently across the years. The winter months (December-March) show high variability but no clear directional trends over time.

```{r annual-mean-rain, fig.width = 10, fig.height = 8, dpi = 300}
ggplot(annual, aes(x = year, y = rtot_in)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, color = "#3366cc") +
  labs(title = "Los Angeles: Annual Total Rainfall (1975-2024)",
       x = "Year", y = "Total Rainfall (in)",
       caption = "Open-Meteo Historical Weather API") +
  theme_bw(base_size = 12)
```

While the LOESS curve suggests increased rainfall in recent years, this very well could be due to natural variability within Los Angeles's highly variable precipitation patterns.

Looking at monthly values over the years, would be more valuable for detecting trends;

```{r timeseries, fig.width = 10, fig.height = 8, dpi = 300}
monthly |>
  pivot_longer(rtot_in:tavg_f) |>
 ggplot(data = _, 
        aes(x = ymd(paste(year, month, 15)),
            y = value)) +
  facet_wrap(~ name, nrow = 2, scales = "free_y",
             labeller = as_labeller(c(
               "rtot_in" = "Total Rainfall (in)",
               "tavg_f" = "Mean Temperature (°F)"))) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, 
              aes(color = name)) +
  labs(title = "Los Angeles: Monthly Climate Data (1975-2024)",
       caption = "Open-Meteo Historical Weather API", 
       x = "", y = "") +
  scale_color_manual(values = c("#3366cc", "#a52b0d")) +
  theme_bw(base_size = 12) +
  theme(legend.position = "None")
```

```{r MannKendall}
t_mk <- Kendall::MannKendall(monthly$tavg_f)
r_mk <- Kendall::MannKendall(monthly$rtot_in)

cat("Temperature: ", round(1-t_mk$sl[1]/2,3)*100, "% confidence in ",
ifelse(t_mk$tau[1] > 0, "upward", "downward"), " trend (t = ", 
round(t_mk$tau[1],3), ")", sep = "")

cat("Rainfall: ", round(1-r_mk$sl[1]/2,3)*100, "% confidence in ",
ifelse(r_mk$tau[1] > 0, "upward", "downward"), " trend (t = ", 
round(r_mk$tau[1],3), ")", sep = "")
```

These calculations, along with the last plot, show **no statistically significant trends** in either temperature or rainfall over the 50-year period. With confidence levels of 77.5% for temperature and 63.3% for rainfall (both well below the standard 95% significance threshold), the observed patterns are likely due to natural variability rather than systematic long-term trends. The very small t values (0.021 for temperature, 0.009 for rainfall) further confirm minimal directional change over time.

# Conclusion

Using the Open-Meteo Historical Weather API, hourly temperature and rainfall data is collected for Los Angeles from 1975 through 2024 and aggregated it into monthly and annual averages.

The Mann-Kendall trend analysis shows no statistically significant temperature or rainfall trends over the 50-year period (temperature: t = 0.021, 77.5% confidence; rainfall: t = 0.009, 63.3% confidence). While the LOESS smoothing curves suggest some variability over time, these patterns fall within the range of natural climate variability and do not represent statistically robust long-term trends. The monthly faceted plots reveal interesting seasonal patterns—some months show apparent warming or cooling—but without statistical significance testing on individual months, these observations remain descriptive rather than conclusive.

Additionally, 50 years represents a **relatively** short period for climate trend analysis and we might need more data to reliably separate long-term climate signals from natural multi-decadal variability cycles like the Pacific Decadal Oscillation. The absence of significant trends in this dataset may reflect both the limited temporal scope and Los Angeles's high natural climate variability.